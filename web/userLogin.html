<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon_io/favicon-16x16.png">
  <link rel="manifest" href="/favicon_io/site.webmanifest">
  <title>OAuth授权-WHOAM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ThreeTenth/css-theme@v0.1.1/colours.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script>
</head>

<body class="black">
  <div id="login">
    <form>
      <div>Email: <input type="email" id="email" /></div>
      <div>Code: <input type="text" id="code" /> <input onclick="loginCode()" type="button" value="获取登录授权码" /></div>
      <input onclick="loginAuth()" type="button" value="登录" />
    </form>
  </div>
  <script>
    function loginCode() {
      const email = document.getElementById('email').value
      const state = Math.random().toString(36).slice(2)

      const form = {
        email: email,
        state: state,
      }

      // js object value of URLSearchParams
      var urlForm = new URLSearchParams()
      for (name in form) {
        urlForm.append(name, form[name])
      }

      axios({
        method: 'post',
        url: '/api/v1/user/main/code',
        data: urlForm,
      })
        .then(function (response) {
          loginToken = response.data
          loginState = state
        })
        .catch(function (error) {
          alert(error.response.data);
        });
    }

    function loginAuth() {
      const email = document.getElementById('email').value
      const state = loginState
      const token = loginToken
      const code = document.getElementById('code').value

      const form = {
        email: email,
        state: state,
        token: token,
        code: code,
      }

      // js object value of URLSearchParams
      var urlForm = new URLSearchParams()
      for (name in form) {
        urlForm.append(name, form[name])
      }

      axios({
        method: 'post',
        url: '/api/v1/user/main/auth',
        data: urlForm,
      })
        .then(function (response) {
          var user = response.data
          Cookies.set('userId', user.userId)
          Cookies.set('accessToken', user.accessToken)
          saveItem("mainToken", user.mainToken)

          window.location.href = "/user/oauth" + window.location.search + "&again=true"
        })
    }

    function saveItem(key, val) {
      if (typeof (Storage) !== "undefined") {
        localStorage.setItem(key, val)
      } else {
        alert("The browser is not supported local storage, please change the browser and try again.")
      }
    }
  </script>
</body>

</html>